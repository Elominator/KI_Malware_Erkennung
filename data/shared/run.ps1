
$procmonLogPath = "C:\Users\WDAGUtilityAccount\Documents\procmon.PML"
$MalwareExecutionTime = 120 # Seconds
function RunProcmon {

    $procmonPath = "C:\Users\WDAGUtilityAccount\Downloads\ProcessMonitor\Procmon64.exe"
    $arguments = "/Quiet /AcceptEula /Backingfile C:\Users\WDAGUtilityAccount\Documents\procmon.PML"

    Start-Process -FilePath $procmonPath -ArgumentList $arguments -NoNewWindow

}

function StopProcmon {

    $procmonPath = "C:\Users\WDAGUtilityAccount\Downloads\ProcessMonitor\Procmon64.exe"
    $arguments = "/Terminate"

    Start-Process -FilePath $procmonPath -ArgumentList $arguments -NoNewWindow

}

function MoveProcmonLog {

    $procmonDestPath = "C:\Users\WDAGUtilityAccount\Downloads\data\procmon.PML"

    Move-Item -Path $procmonLogPath -Destination $procmonDestPath

}

function ProcmonFailed {
    
    $defaultLength = 4194304
    $logFileSize = $(Get-Item $procmonLogPath).Length

    if($logFileSize -lt ($defaultLength + 0.1 * $defaultLength)){
        return $true
    } else {
        return $false
    }
    return $true
}

function ExecuteMalware {
    $scriptPath = "C:\Users\WDAGUtilityAccount\Downloads\executeMalware.ps1"
    Invoke-Expression -Command $scriptPath
}

Start-Sleep -Seconds 5
RunProcmon
Start-Sleep -Seconds 2
while(ProcmonFailed){
    StopProcmon
    Start-Sleep -Seconds 5
    Remove-Item $procmonLogPath
    Start-Sleep -Seconds 1
    RunProcmon
    Start-Sleep -Seconds 2
}

ExecuteMalware
Start-Sleep -Seconds $MalwareExecutionTime

StopProcmon
Start-Sleep -Seconds 5

MoveProcmonLog
Start-Sleep -Seconds 5

"Completed!" | Out-File "C:\Users\WDAGUtilityAccount\Downloads\completed"
shutdown.exe -s -t 1